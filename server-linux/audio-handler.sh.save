#!/bin/bash

# Load PulseAudio module if not already loaded
pactl load-module module-null-sink sink_name=virtual_speaker

# Set the default sink to our virtual speaker
pacmd set-default-sink virtual_speaker

# Variables
MIC_STREAM_PORT=12345
SPEAKER_STREAM_PORT=12346

# Function to receive microphone audio and play through virtual speaker
receive_mic_audio() {
    while true; do
        ffplay -nodisp -i tcp://localhost:$MIC_STREAM_PORT
        sleep 1
    done
}

# Function to capture audio from virtual speaker and stream back
stream_speaker_audio() {
    while true; do
        ./ffmpeg -f pulse -i virtual_speaker.monitor -acodec libmp3lame -b:a 128k -f mp3 tcp://localhost:$SPEAKER_STREAM_PORT
        sleep 1
    done
}

# Main execution
receive_mic_audio &
stream_speaker_audio &

# Keep the script running
wait
